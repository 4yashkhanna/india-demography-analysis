<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demographic Analysis 2011</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        cream: {
                            50: '#FDFBF7', 
                            100: '#F7F5EE',
                            200: '#EFECE2',
                            300: '#E2DED0'
                        },
                        // SEMANTIC PALETTE
                        theme: {
                            primary: '#475569', // Slate 600 (Neutral UI)
                            dark: '#1e293b',    // Slate 800 (Text)
                        },
                        // METRIC IDENTITIES
                        metric: {
                            marriage: '#3b82f6',  // Blue 500
                            fertility: '#8b5cf6', // Violet 500
                            sexRatio: '#e11d48',  // Rose 600
                        },
                        // CATEGORICAL (Strictly for Categories)
                        cat: {
                            rural: '#0d9488',   // Teal 600
                            urban: '#d97706',   // Amber 600
                        },
                        // COMPARISON (Intensity, not Good/Bad)
                        intensity: {
                            high: '#7c3aed',    // Violet 600 (Above Avg)
                            low: '#c4b5fd',     // Violet 300 (Below Avg)
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #FDFBF7; color: #1e293b; }
        
        /* Card Styling */
        .card { 
            background: white; 
            border-radius: 1rem; 
            border: 1px solid #E2DED0; 
            padding: 1.5rem; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .card:hover { 
            border-color: #94a3b8; 
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); 
        }

        .chart-container { position: relative; height: 320px; width: 100%; }
        
        /* Custom Scrollbar for Dropdowns */
        select {
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        /* Tab Styling */
        .tab-btn { 
            padding: 0.75rem 1.25rem; 
            font-weight: 600; 
            font-size: 0.9rem; 
            border-radius: 0.5rem;
            color: #64748b; 
            transition: all 0.2s; 
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab-btn:hover { background-color: #E7E5E4; color: #1e293b; }
        .tab-btn.active { 
            background-color: #475569; 
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Utility */
        .hidden { display: none !important; }
        .modal { position: fixed; inset: 0; background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(4px); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        
        /* Insight Box - Neutral Blue */
        .insight-box { 
            background: linear-gradient(to right, #f0f9ff, #e0f2fe);
            border-left: 4px solid #3b82f6; 
            padding: 1.25rem; 
            font-size: 0.9rem; 
            color: #0c4a6e; 
            margin-bottom: 1.5rem; 
            border-radius: 0.5rem; 
            display: flex; 
            align-items: start; 
            gap: 1rem; 
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="upload-modal" class="modal">
        <div class="bg-white p-10 rounded-2xl shadow-2xl max-w-lg w-full text-center border border-cream-200">
            <div class="mx-auto w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-6 shadow-inner">
                <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            </div>
            <h2 class="text-3xl font-serif font-bold text-slate-800 mb-2">Load Census Data</h2>
            <p class="text-slate-500 mb-8">Upload <code>Assignment 4 Data Viz Total Data (1).csv</code> to generate the report.</p>
            
            <input type="file" id="csvFile" accept=".csv" class="hidden" />
            <label for="csvFile" class="group flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <svg class="w-8 h-8 mb-3 text-slate-400 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="mb-2 text-sm text-slate-600 font-semibold">Click to upload or drag and drop</p>
                </div>
            </label>
            <p id="error-msg" class="text-rose-600 text-sm mt-4 font-semibold hidden flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span id="error-text"></span>
            </p>
        </div>
    </div>

    <div id="dashboard" class="container mx-auto px-4 py-8 max-w-7xl hidden flex-grow">
        
        <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4 border-b border-stone-200 pb-6">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <span class="bg-slate-600 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">Official Report</span>
                    <span class="text-slate-400 text-sm flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        Census 2011
                    </span>
                </div>
                <h1 class="text-4xl font-serif font-black text-slate-800 tracking-tight leading-tight">Demographic Analysis</h1>
                <p class="text-slate-500 mt-2 text-lg">Marriage Timing, Fertility Rates & Gender Balance Indicators</p>
            </div>
            
            <button onclick="document.getElementById('methodology-details').classList.toggle('hidden')" class="text-slate-600 hover:text-slate-900 font-semibold text-sm flex items-center gap-2 bg-white px-4 py-2 rounded-full border border-stone-200 shadow-sm transition-all hover:shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Methodology Guide
            </button>
        </div>

        <div id="methodology-details" class="mb-8 hidden animate-fade">
            <div class="bg-white border border-stone-200 rounded-xl p-6 shadow-soft">
                <h4 class="font-serif font-bold text-slate-800 mb-3">How to read this dashboard</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-slate-600">
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Fertility Proxy:</strong> Uses <em>Mean Children Ever Born (MCEB)</em>.</li>
                        <li><strong>Marriage Timing:</strong> Inferred using <em>% Ever Married</em> in the 20-24 age group.</li>
                    </ul>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>Color Coding:</strong> We use an intensity scale (Dark Purple vs Light Purple) to show values relative to the National Average.</li>
                        <li><strong>Benchmarks:</strong> Dashed lines represent the National Average.</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="sticky top-2 z-40 bg-cream-50/80 backdrop-blur-md border border-white/50 rounded-xl p-4 mb-8 shadow-soft">
            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 w-full grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="relative group">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wider ml-1">State Scope</label>
                        <div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </div>
                        <select id="stateFilter" class="w-full pl-9 pr-8 py-2.5 bg-white border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none shadow-sm transition-shadow"><option value="India">India (National)</option></select>
                    </div>
                    <div class="relative">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wider ml-1">Residence</label>
                        <div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        </div>
                        <select id="residenceFilter" class="w-full pl-9 pr-8 py-2.5 bg-white border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none shadow-sm transition-shadow">
                            <option value="Total">Total</option><option value="Rural">Rural</option><option value="Urban">Urban</option>
                        </select>
                    </div>
                    <div class="relative">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wider ml-1">Education</label>
                        <div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                        </div>
                        <select id="educationFilter" class="w-full pl-9 pr-8 py-2.5 bg-white border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none shadow-sm transition-shadow"><option value="Total">Total</option></select>
                    </div>
                    <div class="relative">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-wider ml-1">Age Group</label>
                        <div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none">
                            <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <select id="ageFilter" class="w-full pl-9 pr-8 py-2.5 bg-white border border-slate-300 rounded-lg text-sm font-medium focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none shadow-sm transition-shadow"><option value="All ages">All Ages</option></select>
                    </div>
                </div>
                <button onclick="resetFilters()" class="px-4 py-2.5 bg-white hover:bg-slate-50 text-slate-600 text-sm font-bold rounded-lg border border-slate-300 transition-colors whitespace-nowrap flex items-center shadow-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Reset
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
            <div class="card group">
                <div class="absolute -right-4 -top-4 opacity-[0.05] group-hover:opacity-10 group-hover:scale-110 transition-all duration-500">
                    <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path></svg>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="p-1.5 bg-slate-100 rounded text-slate-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Sample Size</h3>
                    </div>
                    <div id="kpiWomen" class="text-3xl font-serif font-black text-slate-800 tracking-tight">-</div>
                    <div class="text-xs text-slate-400 mt-1 font-medium">Total Women</div>
                </div>
            </div>

            <div class="card group border-t-4 border-t-metric-marriage">
                <div class="absolute -right-4 -top-4 opacity-[0.05] group-hover:opacity-10 group-hover:scale-110 transition-all duration-500 text-metric-marriage">
                    <svg class="w-32 h-32" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="p-1.5 bg-blue-50 rounded text-metric-marriage"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg></div>
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Marriage</h3>
                    </div>
                    <div id="kpiMarriedPct" class="text-3xl font-serif font-black text-metric-marriage tracking-tight">-</div>
                    <div class="text-xs text-slate-400 mt-1 font-medium">Ever Married</div>
                </div>
            </div>

            <div class="card group border-t-4 border-t-metric-fertility">
                <div class="absolute -right-4 -top-4 opacity-[0.05] group-hover:opacity-10 group-hover:scale-110 transition-all duration-500 text-metric-fertility">
                    <svg class="w-32 h-32" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="p-1.5 bg-violet-50 rounded text-metric-fertility"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg></div>
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Fertility</h3>
                    </div>
                    <div id="kpiFertility" class="text-3xl font-serif font-black text-metric-fertility tracking-tight">-</div>
                    <div class="text-xs text-slate-400 mt-1 font-medium">Mean CEB</div>
                </div>
            </div>

            <div class="card group border-t-4 border-t-metric-sexRatio">
                <div class="absolute -right-4 -top-4 opacity-[0.05] group-hover:opacity-10 group-hover:scale-110 transition-all duration-500 text-metric-sexRatio">
                    <svg class="w-32 h-32" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="p-1.5 bg-rose-50 rounded text-metric-sexRatio"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg></div>
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Sex Ratio</h3>
                    </div>
                    <div id="kpiSexRatio" class="text-3xl font-serif font-black text-metric-sexRatio tracking-tight">-</div>
                    <div class="text-xs text-slate-400 mt-1 font-medium">Females / 1000 Males</div>
                </div>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 mb-8 bg-slate-100 p-1.5 rounded-lg w-full md:w-auto inline-flex">
            <button onclick="switchTab('overview')" id="tab-overview" class="tab-btn active">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Overview
            </button>
            <button onclick="switchTab('patterns')" id="tab-patterns" class="tab-btn">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                Patterns
            </button>
            <button onclick="switchTab('drivers')" id="tab-drivers" class="tab-btn">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                Drivers
            </button>
        </div>

        <div id="view-overview" class="tab-view animate-fade">
            <div class="insight-box">
                <div class="bg-blue-200 p-2 rounded-full">
                    <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <div>
                    <strong class="block text-blue-800 font-bold text-sm mb-1 uppercase tracking-wide">Key Insight</strong>
                    <span class="leading-relaxed">Compare your selected state's curve against the dashed National Average. Deviations in the 15-19 age bracket indicate early marriage patterns.</span>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-serif font-bold text-slate-800 text-lg">Marriage Timing</h3>
                        <span class="text-[10px] uppercase font-bold text-slate-400 bg-slate-50 border px-2 py-1 rounded">By Age Group</span>
                    </div>
                    <div class="chart-container"><canvas id="chartMarriageAge"></canvas></div>
                    <p class="text-xs text-slate-400 mt-4 border-t pt-3">% Ever Married. <span class="hidden" id="nat-legend-1">Dashed line = National Avg.</span></p>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-serif font-bold text-slate-800 text-lg">Fertility Lifecycle</h3>
                        <span class="text-[10px] uppercase font-bold text-slate-400 bg-slate-50 border px-2 py-1 rounded">PER AGE GROUP</span>
                    </div>
                    <div class="chart-container"><canvas id="chartFertilityAge"></canvas></div>
                    <p class="text-xs text-slate-400 mt-4 border-t pt-3">Incremental Mean Children Ever Born (Marginal Increase).</p>
                </div>

                <div class="card lg:col-span-2">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="font-serif font-bold text-slate-800 text-lg">State Variation: Fertility Intensity</h3>
                            <p class="text-sm text-slate-500">Comparing states against the National Average.</p>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="chartStateRank"></canvas></div>
                    <div class="flex flex-wrap gap-4 mt-4 pt-3 border-t text-xs font-medium text-slate-500 justify-center">
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-intensity-high"></span> Above National Avg</div>
                        <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-intensity-low"></span> Below National Avg</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-patterns" class="tab-view hidden animate-fade">
             <div class="insight-box">
                <div class="bg-blue-200 p-2 rounded-full">
                    <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div>
                    <strong class="block text-blue-800 font-bold text-sm mb-1 uppercase tracking-wide">Interactive Analysis</strong>
                    <span class="leading-relaxed">Click any bar in the charts below to <strong>highlight</strong> specific education levels across both graphs. Colors differentiate categories: <span class="text-cat-rural font-bold">Teal (Rural)</span> vs <span class="text-cat-urban font-bold">Amber (Urban)</span>.</span>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-serif font-bold text-slate-800 text-lg">Marriage Curves: High vs Low Fertility States</h3>
                    </div>
                    <div class="chart-container"><canvas id="chartMarriageCurves"></canvas></div>
                    <div class="text-xs text-slate-400 mt-2 text-center">
                        <span class="text-intensity-high font-bold">● High Fertility Group</span> vs <span class="text-intensity-low font-bold">● Low Fertility Group</span>
                    </div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-serif font-bold text-slate-800 text-lg">Fertility by Education</h3>
                        <span class="text-[10px] uppercase font-bold text-slate-400 bg-slate-50 border px-2 py-1 rounded">Interactive</span>
                    </div>
                    <div class="chart-container"><canvas id="chartEduGradient"></canvas></div>
                    <p class="text-xs text-slate-400 mt-4 border-t pt-3 flex items-center justify-between">
                        <span>Impact of education on MCEB.</span>
                        <span class="font-semibold text-slate-600">--- Dashed Line: National Avg.</span>
                    </p>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-serif font-bold text-slate-800 text-lg">Rural-Urban Divergence</h3>
                        <span class="text-[10px] uppercase font-bold text-slate-400 bg-slate-50 border px-2 py-1 rounded">Interactive</span>
                    </div>
                    <div class="chart-container"><canvas id="chartRuralUrban"></canvas></div>
                    <div class="text-xs text-slate-400 mt-4 border-t pt-3 flex flex-col gap-1">
                         <div class="flex justify-between">
                            <span>Comparing fertility rates.</span>
                            <span class="font-semibold text-slate-600">--- Dashed Line: National Avg.</span>
                         </div>
                         <div class="flex gap-4">
                             <span class="text-cat-rural font-bold">● Rural</span> 
                             <span class="text-cat-urban font-bold">● Urban</span>
                         </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-drivers" class="tab-view hidden animate-fade">
             <div class="insight-box">
                <div class="bg-blue-200 p-2 rounded-full">
                    <svg class="w-5 h-5 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                </div>
                <div>
                    <strong class="block text-blue-800 font-bold text-sm mb-1 uppercase tracking-wide">Correlation Check</strong>
                    <span class="leading-relaxed">Strong correlations suggest that delaying marriage (X-axis) directly reduces fertility (Y-axis).</span>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-serif font-bold text-slate-800 text-lg">Marriage vs. Fertility</h3>
                        <div class="flex items-center gap-3">
                            <span id="corr-val-1" class="text-xs font-mono font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded border border-slate-200">r = --</span>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="trendToggle" class="sr-only peer" onchange="updateDashboard()">
                                <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-slate-600"></div>
                                <span class="ms-2 text-xs font-medium text-gray-500">Trend</span>
                            </label>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="chartScatterMarriageFertility"></canvas></div>
                </div>

                <div class="card">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-serif font-bold text-slate-800 text-lg">Fertility vs. Sex Ratio</h3>
                    </div>
                    <div class="chart-container"><canvas id="chartScatterGender"></canvas></div>
                    <p class="text-xs text-slate-400 mt-4 border-t pt-3"><span class="text-intensity-high font-bold">Dark Purple Points</span> = Higher Fertility States.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let rawData = [];
        let filters = { state: 'India', residence: 'Total', education: 'Total', age: 'All ages' };
        let charts = {};
        let nationalAvg = { fertility: 0, sexRatio: 0 };
        let selectedEduIndex = null; 

        // UPDATED: Semantic Color System (No Good/Bad, No False Correlation)
        const COLORS = {
            // Identity
            marriage: '#3b82f6',  // Blue
            fertility: '#8b5cf6', // Violet
            
            // Comparison / Intensity (Monochromatic)
            high: '#7c3aed',      // Dark Violet (Above Avg)
            low: '#c4b5fd',       // Light Violet (Below Avg)
            
            // Categories (Distinct)
            rural: '#0d9488',     // Teal
            urban: '#d97706',     // Amber
            
            // Neutrals
            black: '#1e293b',     // Selected State
            gray: '#e2e8f0',      // Inactive
            text: '#64748b'       // Legend text
        };

        const eduOrder = ['Total', 'Illiterate', 'Literate', 'Literate but below primary', 'Primary but below middle', 'Middle but below matric or secondary', 'Matric or secondary but below graduate', 'Graduate and above'];
        // UPDATED: Clearer Labels
        const eduShortLabels = ['Illiterate', 'Literate', 'Below Primary', 'Primary', 'Middle', 'Matric/Sec.', 'Graduate'];
        const ageOrder = ['All ages', 'Less than 15', '15-19', '20-24', '25-29', '30-34', '35-39', '40-44', '45-49', '50-54', '55-59', '60-64', '65-69', '70-74', '75-79', '80+'];

        // --- FILE HANDLING ---
        document.getElementById('csvFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: false, skipEmptyLines: true,
                complete: (results) => {
                    try { processData(results.data); initDashboard(); } 
                    catch (err) { 
                        document.getElementById('error-msg').classList.remove('hidden');
                        document.getElementById('error-text').innerText = "Error parsing file. Check format.";
                    }
                }
            });
        });

        function processData(rows) {
            rawData = [];
            rows.forEach(r => {
                if(!r[0] || !r[0].toString().includes('F0503')) return;
                const num = (v) => parseInt(String(v).replace(/,/g, '')) || 0;
                let s = r[3].toString().toUpperCase().replace('STATE - ', '').replace('UNION TERRITORY - ', '').replace(/ \d+$/, '').trim();
                s = s.charAt(0) + s.slice(1).toLowerCase();
                s = s.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
                rawData.push({
                    State: s, Residence: r[4], Education: r[5], Age: r[6],
                    Women: num(r[7]), Married: num(r[8]), Children: num(r[17]), Boys: num(r[18]), Girls: num(r[19])
                });
            });
            const nat = rawData.find(d => d.State === 'India' && d.Residence === 'Total' && d.Education === 'Total' && d.Age === 'All ages');
            if(nat && nat.Women > 0) {
                nationalAvg.fertility = nat.Children / nat.Women;
                nationalAvg.sexRatio = nat.Boys > 0 ? (nat.Girls / nat.Boys) * 1000 : 0;
            }
            document.getElementById('upload-modal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        // --- DASHBOARD LOGIC ---
        function initDashboard() { populateDropdowns(); setupListeners(); updateDashboard(); }

        function populateDropdowns() {
            const states = [...new Set(rawData.map(d => d.State))].sort().filter(s => s !== 'India');
            const sSel = document.getElementById('stateFilter');
            sSel.innerHTML = '<option value="India">India (National)</option><option value="All">Compare All States</option>';
            states.forEach(s => sSel.add(new Option(s, s)));
            
            const eSel = document.getElementById('educationFilter'); eSel.innerHTML = '';
            eduOrder.forEach(e => eSel.add(new Option(e, e)));
            
            const aSel = document.getElementById('ageFilter'); aSel.innerHTML = '';
            ageOrder.forEach(a => aSel.add(new Option(a, a)));
        }

        function setupListeners() {
            ['state', 'residence', 'education', 'age'].forEach(k => {
                document.getElementById(k+'Filter').addEventListener('change', (e) => {
                    filters[k] = e.target.value; updateDashboard();
                });
            });
        }

        function resetFilters() {
            document.getElementById('stateFilter').value = 'India';
            document.getElementById('residenceFilter').value = 'Total';
            document.getElementById('educationFilter').value = 'Total';
            document.getElementById('ageFilter').value = 'All ages';
            filters = { state: 'India', residence: 'Total', education: 'Total', age: 'All ages' };
            selectedEduIndex = null; updateDashboard();
        }

        window.switchTab = function(tId) {
            document.querySelectorAll('.tab-view').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-'+tId).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+tId).classList.add('active');
        };

        function updateDashboard() { updateKPIs(); renderCharts(); }

        function getFilteredRow(override = {}) {
            const f = { ...filters, ...override };
            const s = f.state === 'All' ? 'India' : f.state;
            return rawData.find(d => d.State === s && d.Residence === f.residence && d.Education === f.education && d.Age === f.age);
        }

        function updateKPIs() {
            const d = getFilteredRow();
            if (d) {
                document.getElementById('kpiWomen').innerText = d.Women.toLocaleString();
                document.getElementById('kpiMarriedPct').innerText = d.Women > 0 ? ((d.Married/d.Women)*100).toFixed(1) + '%' : '0%';
                document.getElementById('kpiFertility').innerText = d.Women > 0 ? (d.Children/d.Women).toFixed(2) : '0';
                document.getElementById('kpiSexRatio').innerText = d.Boys > 0 ? ((d.Girls/d.Boys)*1000).toFixed(0) : '0';
            }
        }

        function destroy(id) { if(charts[id]) charts[id].destroy(); }

        function calculateCorrelation(data) {
            const n = data.length; if(n < 2) return 0;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
            data.forEach(d => { sumX += d.x; sumY += d.y; sumXY += d.x * d.y; sumX2 += d.x * d.x; sumY2 += d.y * d.y; });
            const num = n * sumXY - sumX * sumY;
            const den = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            return den === 0 ? 0 : num / den;
        }

        // --- CHARTS ---
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = "#475569";

        function handleEduClick(evt, elems, chart) {
            if (elems.length > 0) selectedEduIndex = elems[0].index;
            else selectedEduIndex = null;
            renderPatterns(); 
        }
        
        function renderCharts() { renderOverview(); renderPatterns(); renderDrivers(); }

        function renderOverview() {
            const showComparison = filters.state !== 'India' && filters.state !== 'All';
            if(showComparison) document.getElementById('nat-legend-1').classList.remove('hidden');
            else document.getElementById('nat-legend-1').classList.add('hidden');

            // 1. Marriage Age (Uses Marriage Identity Color: Blue)
            destroy('chartMarriageAge');
            const mData = ageOrder.slice(1).map(a => {
                const d = getFilteredRow({ age: a }); return d && d.Women > 0 ? (d.Married/d.Women)*100 : 0;
            });

            let datasets1 = [{ label: filters.state === 'All' ? 'All States' : filters.state, data: mData, backgroundColor: COLORS.marriage, order: 1, borderRadius: 4 }];
            if (showComparison) {
                const natData = ageOrder.slice(1).map(a => { const d = getFilteredRow({ state: 'India', age: a }); return d && d.Women > 0 ? (d.Married/d.Women)*100 : 0; });
                datasets1.push({ label: 'National Avg', data: natData, type: 'line', borderColor: '#94a3b8', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, order: 0 });
            }
            charts['chartMarriageAge'] = new Chart(document.getElementById('chartMarriageAge'), {
                type: 'bar', data: { labels: ageOrder.slice(1), datasets: datasets1 }, options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false } } }
            });

            // 2. Fertility Age (Uses Fertility Identity Color: Violet)
            destroy('chartFertilityAge');
            const getCumulData = (st) => ageOrder.slice(1).map(a => { const d = getFilteredRow({ state: st, age: a }); return d && d.Women > 0 ? d.Children/d.Women : 0; });
            const cumulativeVals = getCumulData(filters.state === 'All' ? 'India' : filters.state);
            const marginalData = cumulativeVals.map((v, i, arr) => { if(i === 0) return v; const diff = v - arr[i-1]; return diff > 0 ? diff : 0; });

            let datasets2 = [{ label: filters.state, data: marginalData, borderColor: COLORS.fertility, backgroundColor: '#ddd6fe', fill: true, order: 1, tension: 0.3 }];
            if (showComparison) {
                const natCumul = getCumulData('India');
                const natMarginal = natCumul.map((v, i, arr) => { if(i === 0) return v; const diff = v - arr[i-1]; return diff > 0 ? diff : 0; });
                datasets2.push({ label: 'National Avg', data: natMarginal, borderColor: '#94a3b8', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, order: 0, fill: false });
            }
            charts['chartFertilityAge'] = new Chart(document.getElementById('chartFertilityAge'), {
                type: 'line', data: { labels: ageOrder.slice(1), datasets: datasets2 }, 
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `+${ctx.raw.toFixed(2)} children` } } } }
            });

            // 3. State Rank (Uses Intensity Colors: High/Low Violet)
            destroy('chartStateRank');
            const states = [...new Set(rawData.map(d=>d.State))].filter(s=>s!=='India');
            const rankData = states.map(s => {
                const d = rawData.find(r => r.State === s && r.Residence === filters.residence && r.Education === filters.education && r.Age === filters.age);
                return { s, v: d && d.Women > 0 ? d.Children/d.Women : 0 };
            }).sort((a,b) => b.v - a.v);
            const displayData = [...rankData.slice(0, 5), ...rankData.slice(-5)]; 

            charts['chartStateRank'] = new Chart(document.getElementById('chartStateRank'), {
                type: 'bar',
                data: {
                    labels: displayData.map(d=>d.s),
                    datasets: [{ 
                        label: 'Mean CEB', 
                        data: displayData.map(d=>d.v), 
                        backgroundColor: (ctx) => {
                            if (ctx.raw.s === filters.state) return COLORS.black; 
                            return displayData[ctx.dataIndex].v > nationalAvg.fertility ? COLORS.high : COLORS.low;
                        },
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, animation: { duration: 400 },
                    plugins: { legend: { display: false }, annotation: { annotations: { line1: { type: 'line', yMin: nationalAvg.fertility, yMax: nationalAvg.fertility, borderColor: '#64748b', borderDash: [4,4], borderWidth: 1, label: { display: true, content: 'National Avg', position: 'end', backgroundColor: 'rgba(0,0,0,0.7)', font: { size: 10 } } } } } }
                }
            });
        }

        function renderPatterns() {
            // 4. Marriage Curves (Uses Intensity Colors)
            destroy('chartMarriageCurves');
            const states = [...new Set(rawData.map(d=>d.State))].filter(s=>s!=='India');
            const sRank = states.map(s => {
                const d = rawData.find(r => r.State === s && r.Residence === 'Total' && r.Education === 'Total' && r.Age === 'All ages');
                return { s, v: d ? d.Children/d.Women : 0 };
            }).sort((a,b) => b.v - a.v);
            
            const focus = [...sRank.slice(0,3), ...sRank.slice(-3)];
            const ages = ['15-19', '20-24', '25-29', '30-34'];
            const datasets = focus.map((f, i) => {
                const data = ages.map(a => {
                    const d = rawData.find(r => r.State === f.s && r.Residence === 'Total' && r.Education === 'Total' && r.Age === a);
                    return d && d.Women > 0 ? (d.Married/d.Women)*100 : 0;
                });
                // Top 3 (High Fert) get Dark Violet, Bottom 3 get Light Violet
                return { label: f.s, data, borderColor: i<3 ? COLORS.high : COLORS.low, borderDash: i<3 ? [] : [5,5], tension: 0.3 };
            });

            charts['chartMarriageCurves'] = new Chart(document.getElementById('chartMarriageCurves'), {
                type: 'line', data: { labels: ages, datasets }, options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 } }
            });

            // 5. Education Gradient (Uses Fertility Identity Color)
            destroy('chartEduGradient');
            const edus = eduOrder.slice(1);
            const eduVals = edus.map(e => {
                const d = rawData.find(r => r.State === (filters.state==='All'?'India':filters.state) && r.Residence === filters.residence && r.Education === e && r.Age === filters.age);
                return d && d.Women > 0 ? d.Children/d.Women : 0;
            });
            charts['chartEduGradient'] = new Chart(document.getElementById('chartEduGradient'), {
                type: 'bar', 
                data: { 
                    labels: eduShortLabels, 
                    datasets: [{ 
                        label: 'Mean CEB', 
                        data: eduVals, 
                        backgroundColor: (ctx) => (selectedEduIndex !== null && ctx.dataIndex !== selectedEduIndex) ? COLORS.gray : COLORS.fertility, 
                        borderRadius: 4 
                    }] 
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, 
                    plugins: { legend: { display: false }, annotation: { annotations: { line1: { type: 'line', yMin: nationalAvg.fertility, yMax: nationalAvg.fertility, borderColor: '#64748b', borderDash: [6,6], borderWidth: 1 } } } },
                    onClick: handleEduClick 
                }
            });

            // 6. Rural Urban (Uses Unique Category Colors: Teal/Amber)
            destroy('chartRuralUrban');
            const rData = edus.map(e => { const d = rawData.find(r => r.State === (filters.state==='All'?'India':filters.state) && r.Residence === 'Rural' && r.Education === e && r.Age === filters.age); return d ? d.Children/d.Women : 0; });
            const uData = edus.map(e => { const d = rawData.find(r => r.State === (filters.state==='All'?'India':filters.state) && r.Residence === 'Urban' && r.Education === e && r.Age === filters.age); return d ? d.Children/d.Women : 0; });
            
            charts['chartRuralUrban'] = new Chart(document.getElementById('chartRuralUrban'), {
                type: 'bar', 
                data: { 
                    labels: eduShortLabels, 
                    datasets: [
                        { label: 'Rural', data: rData, backgroundColor: (ctx) => (selectedEduIndex !== null && ctx.dataIndex !== selectedEduIndex) ? COLORS.gray : COLORS.rural, borderRadius: 4 }, 
                        { label: 'Urban', data: uData, backgroundColor: (ctx) => (selectedEduIndex !== null && ctx.dataIndex !== selectedEduIndex) ? COLORS.gray : COLORS.urban, borderRadius: 4 }
                    ] 
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, animation: { duration: 400 },
                    plugins: { annotation: { annotations: { line1: { type: 'line', yMin: nationalAvg.fertility, yMax: nationalAvg.fertility, borderColor: '#64748b', borderDash: [6,6], borderWidth: 1 } } } },
                    onClick: handleEduClick
                }
            });
        }

        function renderDrivers() {
            const states = [...new Set(rawData.map(d=>d.State))].filter(s=>s!=='India');
            const selectedState = filters.state !== 'India' && filters.state !== 'All' ? filters.state : null;
            const showTrend = document.getElementById('trendToggle')?.checked || false;
            
            // 7. Scatter: Marriage vs Fertility (Uses Intensity Colors)
            destroy('chartScatterMarriageFertility');
            const sc1 = states.map(s => {
                const m = rawData.find(d => d.State === s && d.Residence === 'Total' && d.Education === 'Total' && d.Age === '20-24');
                const f = rawData.find(d => d.State === s && d.Residence === 'Total' && d.Education === 'Total' && d.Age === 'All ages');
                if(!m || !f) return null;
                return { x: (m.Married/m.Women)*100, y: f.Children/f.Women, s };
            }).filter(d=>d);

            const corr = calculateCorrelation(sc1);
            document.getElementById('corr-val-1').innerText = `r = ${corr.toFixed(2)}`;

            // Trend Calculation with Safety Check
            const n = sc1.length;
            let trendData = [];
            if(n > 1) {
                let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                sc1.forEach(d => { sumX += d.x; sumY += d.y; sumXY += d.x * d.y; sumXX += d.x * d.x; });
                const denominator = (n * sumXX - sumX * sumX);
                if (denominator !== 0) {
                    const slope = (n * sumXY - sumX * sumY) / denominator;
                    const intercept = (sumY - slope * sumX) / n;
                    trendData = [{ x: Math.min(...sc1.map(d=>d.x)), y: slope * Math.min(...sc1.map(d=>d.x)) + intercept }, { x: Math.max(...sc1.map(d=>d.x)), y: slope * Math.max(...sc1.map(d=>d.x)) + intercept }];
                }
            }

            const datasets1 = [{ 
                label: 'States', 
                data: sc1, 
                pointStyle: 'circle', // Force Legend Circle
                pointRadius: (ctx) => ctx.raw?.s === selectedState ? 8 : 6,
                backgroundColor: (ctx) => ctx.raw?.s === selectedState ? COLORS.black : (ctx.raw.y > nationalAvg.fertility ? COLORS.high : COLORS.low),
                pointBorderColor: '#ffffff', pointBorderWidth: 1, order: 1,
                hoverRadius: 10
            }];
            
            if(showTrend && trendData.length > 0) {
                datasets1.push({ 
                    label: 'Global Trend', 
                    data: trendData, 
                    type: 'line', 
                    pointStyle: 'line', // Force Legend Line
                    borderColor: '#475569', 
                    borderWidth: 2, 
                    borderDash: [5,5], 
                    pointRadius: 0, 
                    fill: false, 
                    order: 0 
                });
            }

            charts['chartScatterMarriageFertility'] = new Chart(document.getElementById('chartScatterMarriageFertility'), {
                type: 'scatter', data: { datasets: datasets1 },
                options: { 
                    responsive: true, maintainAspectRatio: false, animation: { duration: 400 },
                    scales: { x: { title: { display: true, text: '% Married (Age 20-24)' } }, y: { title: { display: true, text: 'Mean CEB' } } },
                    plugins: { 
                        legend: { labels: { usePointStyle: true } },
                        tooltip: { callbacks: { label: c => c.dataset.type==='line'?'Trend Line': `${c.raw.s}: ${c.raw.x.toFixed(1)}% Mar, ${c.raw.y.toFixed(2)} CEB` } },
                        annotation: { annotations: { line1: { type: 'line', yMin: nationalAvg.fertility, yMax: nationalAvg.fertility, borderColor: '#64748b', borderDash: [2,2], borderWidth: 1 } } }
                    }
                }
            });

            // 8. Scatter: Gender Bias (Uses Intensity Colors)
            destroy('chartScatterGender');
            const sc2 = states.map(s => {
                const d = rawData.find(r => r.State === s && r.Residence === 'Total' && r.Education === 'Total' && r.Age === 'All ages');
                if(!d || d.Boys===0) return null;
                return { x: d.Children/d.Women, y: (d.Girls/d.Boys)*1000, s };
            }).filter(d=>d);

            charts['chartScatterGender'] = new Chart(document.getElementById('chartScatterGender'), {
                type: 'scatter',
                data: { datasets: [{ 
                    label: 'States', 
                    data: sc2, 
                    pointStyle: 'circle', // Force Legend Circle
                    pointRadius: (ctx) => ctx.raw?.s === selectedState ? 8 : 6,
                    backgroundColor: (ctx) => ctx.raw?.s === selectedState ? COLORS.black : (ctx.raw.x > nationalAvg.fertility ? COLORS.high : COLORS.low),
                    pointBorderColor: '#ffffff', pointBorderWidth: 1, hoverRadius: 10
                }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, animation: { duration: 400 },
                    scales: { x: { title: { display: true, text: 'Mean CEB' } }, y: { title: { display: true, text: 'Sex Ratio (F/1000M)' } } },
                    plugins: { 
                        legend: { labels: { usePointStyle: true } },
                        tooltip: { callbacks: { label: c => `${c.raw.s}: ${c.raw.x.toFixed(2)} CEB, ${c.raw.y.toFixed(0)} Ratio` } },
                        annotation: { annotations: { 
                            lineY: { type: 'line', yMin: nationalAvg.sexRatio, yMax: nationalAvg.sexRatio, borderColor: '#64748b', borderDash: [2,2], borderWidth: 1 },
                            lineX: { type: 'line', xMin: nationalAvg.fertility, xMax: nationalAvg.fertility, borderColor: '#64748b', borderDash: [2,2], borderWidth: 1 }
                        }}
                    }
                }
            });
        }
    </script>
</body>
</html>